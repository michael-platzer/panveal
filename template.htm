<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>$(TITLE)</title>
    <link rel="stylesheet" href="$(REVEAL_CSS)">
    <link rel="stylesheet" href="$(REVEAL_THEME)">
  </head>
  <body>

    <div class="reveal">
      <div class="slides" id="slides">
      </div>
    </div>

    <script>
        // list of slides which animate themselves (= self-anims):
        var selfanims = [];

        // add all SVG slides to selfanims
        svg_slides = document.querySelectorAll("#slides .svg-slide");
        for (i = 0; i < svg_slides.length; i++) {
            addSVGslide(svg_slides[i]);
        }

        /**
         * Initialize Reveal and set up a fragment event listeners.
         */
        function initReveal() {
            Reveal.initialize();

            Reveal.addEventListener("fragmentshown", function(event) {
                var frag = event.fragment;
                var frag_parent = frag.parentElement;
                var idx = parseInt(frag.getAttribute("data-fragment-index"));

                for (var i = 0; i < selfanims.length; i++)
                    if (selfanims[i].sect == frag_parent)
                        selfanims[i].next(idx);
            });
            Reveal.addEventListener("fragmenthidden", function(event) {
                var frag = event.fragment;
                var frag_parent = frag.parentElement;
                var idx = parseInt(frag.getAttribute("data-fragment-index"));

                for (var i = 0; i < selfanims.length; i++)
                    if (selfanims[i].sect == frag_parent)
                        selfanims[i].prev(idx);
            });
        }

        /**
         * Add an SVG slide to the self-anims.
         */
        function addSVGslide(slide) {
            var svg_obj = slide.firstElementChild;

            // get all groups (<g> tags) of the SVG file:
            var groups = svg_obj.getElementsByTagName("g");

            // number of animation steps:
            var steps = 0;
            // list of transitions, with the layers to show at each step:
            var layers_show = [];
            // list of transitions, with the layers to hide at each step:
            var layers_hide = [];

            for (var i = 0; i < groups.length; i++)
                if (groups[i].getAttribute("inkscape:groupmode") == "layer") {
                    var onlystr = groups[i].getAttribute("inkscape:label").split(",");
                    var show_at_start = false;

                    for (var j = 0; j < onlystr.length; j++) {
                        var subs = onlystr[j].split("-");
                        var off, end;
                        if (subs.length == 1)
                            off = end = parseInt(subs[0]);
                        else {
                            off = (subs[0] == '') ? 0 : parseInt(subs[0]);
                            end = (subs[1] == '') ? -1 : parseInt(subs[1]);
                        }
                        if (off >= steps || end >= steps) {
                            for (; steps <= off || steps <= end; steps++) {
                                layers_show[steps] = [];
                                layers_hide[steps] = [];
                            }
                        }

                        if (off > 0)
                            layers_show[off - 1].push(groups[i].id);
                        if (0 <= end)
                            layers_hide[end].push(groups[i].id);

                        if (off == 0)
                            show_at_start = true;
                    }

                    // set each layer to its initial state:
                    groups[i].style.display = show_at_start ? "inline" : "none";
                }

            // add a fragment for each animation transition:
            // (there is one less transition than the number of steps)
            for (var i = 0; i < steps - 1; i++) {
                var frag = document.createElement("div");
                frag.setAttribute("class", "fragment");
                frag.style.display = "none";
                slide.appendChild(frag);
            }
            selfanims.push({
                sect: slide,
                elems_show: layers_show,
                elems_hide: layers_hide,
                next: function(idx) {
                    var svg_obj = this.sect.firstElementChild;
                    for (var i = 0; i < this.elems_show[idx].length; i++)
                        svg_obj.getElementById(this.elems_show[idx][i]).style.display = "inline";
                    for (var i = 0; i < this.elems_hide[idx].length; i++)
                        svg_obj.getElementById(this.elems_hide[idx][i]).style.display = "none";
                },
                prev: function(idx) {
                    var svg_obj = this.sect.firstElementChild;
                    for (var i = 0; i < this.elems_show[idx].length; i++)
                        svg_obj.getElementById(this.elems_show[idx][i]).style.display = "none";
                    for (var i = 0; i < this.elems_hide[idx].length; i++)
                        svg_obj.getElementById(this.elems_hide[idx][i]).style.display = "inline";
                }
            });
        }
    </script>

    <script src="$(REVEAL_JS)" onload="initReveal()"></script>

  </body>
</html>
